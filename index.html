<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ghost Call</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #000; color: white; overflow: hidden; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(0.95); opacity: 0.5; } }
        #overlay { position: fixed; inset: 0; background: black; z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-between py-12 px-6">

    <!-- ЭКРАН ВХОДА (Чтобы разрешить звук) -->
    <div id="overlay">
        <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-500/20">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
        </div>
        <h2 class="text-xl font-bold mb-8">Анонимная комната</h2>
        <button onclick="startCallFlow()" class="bg-white text-black px-10 py-4 rounded-full font-bold uppercase tracking-widest active:scale-95 transition-all">Войти в звонок</button>
    </div>

    <div class="text-center">
        <p id="status" class="text-xs tracking-widest text-gray-500 uppercase">Инициализация...</p>
        <h1 id="timer" class="text-6xl font-light mt-4 tabular-nums">00:00</h1>
    </div>

    <div class="relative">
        <div id="avatar-ring" class="w-40 h-40 rounded-full border-2 border-green-500/30 flex items-center justify-center">
            <div class="w-32 h-32 rounded-full bg-green-500/20 flex items-center justify-center">
                <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" d="M12 2L3 7V12C3 17.5 7 21.5 12 22C17 21.5 21 17.5 21 12V7L12 2Z"/><circle cx="12" cy="11" r="3"/><path d="M7 17C7 15.5 8.5 14.5 12 14.5C15.5 14.5 17 15.5 17 17"/></svg>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-8 w-full max-w-xs">
        <!-- Микрофон -->
        <button id="mic-btn" onclick="toggleMic()" class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center">
            <svg id="mic-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
        </button>

        <!-- Сброс -->
        <button onclick="tg.close()" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 rotate-[135deg] text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79a15.1 15.1 0 006.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.24.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
        </button>

        <!-- Жалоба -->
        <button onclick="report()" class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const SERVER_URL = 'https://ghost-call-server-3.onrender.com';
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('tgWebAppStartParam') || 'test';

        let socket, localStream, peerConnection, isMuted = false, timerInterval;

        async function startCallFlow() {
            document.getElementById('overlay').style.display = 'none';
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                initSocket();
            } catch (e) { alert("Микрофон недоступен!"); }
        }

        function initSocket() {
            socket = io(SERVER_URL);
            socket.on('connect', () => {
                document.getElementById('status').innerText = "Ожидание собеседника...";
                socket.emit('join-room', roomId);
            });

            socket.on('user-connected', () => createPeer(true));
            
            socket.on('signal', async data => {
                if (!peerConnection) createPeer(false);
                if (data.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('signal', { roomId, signal: { answer } });
                } else if (data.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                } else if (data.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            });
        }

        function createPeer(isInitiator) {
            peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

            peerConnection.ontrack = e => {
                const audio = new Audio();
                audio.srcObject = e.streams[0];
                audio.play
 
();
                startLiveSession();
            };

            peerConnection.onicecandidate = e => {
                if (e.candidate) socket.emit('signal', { roomId, signal: { candidate: e.candidate } });
            };

            if (isInitiator) {
                peerConnection.onnegotiationneeded = async () => {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('signal', { roomId, signal: { offer } });
                };
            }
        }

        function startLiveSession() {
            document.getElementById('status').innerText = "В эфире";
            document.getElementById('avatar-ring').classList.add('pulse');
            if (timerInterval) return;
            let sec = 0;
            timerInterval = setInterval(() => {
                sec++;
                const m = Math.floor(sec/60).toString().padStart(2,'0');
                const s = (sec%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function toggleMic() {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('mic-btn').classList.toggle('bg-white');
            document.getElementById('mic-btn').classList.toggle('text-black');
            document.getElementById('mic-icon').style.color = isMuted ? 'red' : '';
        }

        function report() {
            if(confirm("Пожаловаться на мошенничество?")) {
                socket.emit('report', { roomId });
                tg.showAlert("Жалоба отправлена!");
                tg.close();
            }
        }
    </script>
</body>
</html>
